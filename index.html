<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pantry Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      margin: 0;
      padding: 0;
      transition: background 0.3s, color 0.3s;
    }
    body.light {
      background-color: #f9f9f9;
      color: #333;
    }
    body.dark {
      background-color: #1f1f1f;
      color: #fff;
    }
    header {
      background-color: #6200ea;
      color: white;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .toggle-btn, button {
      background-color: #6200ea;
      color: white;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #3700b3;
    }
    .form-container, .scanner, .search-box {
      margin: 1rem;
      background-color: white;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    input {
      margin: 0.5rem 0;
      padding: 0.5rem;
      width: 100%;
      font-size: 1rem;
    }
    .item-card {
      background-color: white;
      margin: 1rem;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .item-info p {
      margin: 0.3rem 0;
    }
    .item-actions button {
      margin-left: 0.5rem;
    }
    .pantry-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding: 1rem;
    }
    body.dark .form-container, body.dark .scanner, body.dark .item-card, body.dark .search-box {
      background-color: #333;
      color: white;
    }
  </style>
</head>
<body class="light">
  <header>
    <h1>üçé Pantry Tracker</h1>
    <button class="toggle-btn" onclick="toggleDarkMode()">üåì Theme</button>
  </header>

  <div class="scanner">
    <button onclick="startScanner()">Start Barcode Scanner</button>
    <div id="reader"></div>
    <br><br>
    <button onclick="testSync()">üß™ Test Google Sheets Sync</button>
    <div id="syncStatus" style="margin-top: 0.5rem; font-weight: bold;"></div>
  </div>

  <div class="form-container">
    <input id="barcode" type="text" placeholder="Barcode" />
    <input id="name" type="text" placeholder="Item Name" />
    <input id="brand" type="text" placeholder="Brand" />
    <input id="quantity" type="number" placeholder="Quantity" min="1" value="1" />
    <input id="expiry" type="date" />
    <input id="category" type="text" placeholder="Category (e.g. Snacks, Dairy)" />
    <button onclick="addItem()">Add Item</button>
  </div>

  <div class="search-box">
    <input type="search" id="searchInput" placeholder="Search..." oninput="renderPantry()" />
  </div>

  <div class="pantry-list" id="pantryList"></div>

  <audio id="beep" src="https://www.soundjay.com/buttons/beep-07.mp3"></audio>

  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz5D3kpdxDv9byNhZDUDzaAuBrxCCEDIww6bQrT_87CLQ9jIS1KP5OSLwM4pPiTMjzC/exec';
    let pantry = JSON.parse(localStorage.getItem('pantryItems')) || [];
    let scanner = null;

    async function loadFromGoogleSheets() {
      try {
        const res = await fetch(SCRIPT_URL);
        const data = await res.json();
        pantry = data.map(row => ({
          barcode: row.Barcode,
          name: row.Name,
          brand: row.Brand,
          quantity: parseInt(row.Quantity),
          expiry: row.Expiry,
          category: row.Category
        }));
        localStorage.setItem('pantryItems', JSON.stringify(pantry));
        renderPantry();
      } catch (err) {
        console.error('Sheet fetch error:', err);
        renderPantry(); // fallback to localStorage
      }
    }

    function renderPantry() {
      const list = document.getElementById('pantryList');
      const query = document.getElementById('searchInput').value.toLowerCase();
      list.innerHTML = '';
      pantry.filter(item =>
        (item.name || "").toLowerCase().includes(query)
        (item.brand || "").toLowerCase().includes(query)
      ).forEach((item, i) => {
        const days = daysUntil(item.expiry);
        let expiryColor = days < 0 ? 'darkred' : days <= 3 ? 'red' : days <= 7 ? 'orange' : '';
        let qtyStyle = item.quantity === 0 ? 'gray;text-decoration:line-through;' :
                       item.quantity === 1 ? 'orange' : '';

        list.innerHTML += `
          <div class="item-card">
            <div class="item-info">
              <p><strong>${item.name}</strong> (${item.brand})</p>
              <p style="color:${qtyStyle}">Qty: ${item.quantity}
                ${item.expiry ? `<span style="color:${expiryColor}"> | üóì ${item.expiry}</span>` : ''}</p>
            </div>
            <div class="item-actions">
              <button onclick="changeQty(${i},1)">Ôºã</button>
              <button onclick="changeQty(${i},-1)">Ôºç</button>
              <button onclick="removeItem(${i})">üóëÔ∏è</button>
            </div>
          </div>`;
      });
      localStorage.setItem('pantryItems', JSON.stringify(pantry));
    }

    function daysUntil(dateStr) {
      if (!dateStr) return Infinity;
      const today = new Date();
      const expiry = new Date(dateStr);
      return Math.floor((expiry - today) / (1000 * 60 * 60 * 24));
    }

    function addItem() {
      const b = document.getElementById('barcode').value.trim();
      const n = document.getElementById('name').value.trim();
      const br = document.getElementById('brand').value.trim();
      const q = +document.getElementById('quantity').value;
      const e = document.getElementById('expiry').value;
      const c = document.getElementById('category').value.trim().toLowerCase();

      const match = pantry.find(i =>
        i.barcode === b && i.name === n && i.brand === br &&
        i.expiry === e && i.category.toLowerCase() === c
      );

      if (match) {
        match.quantity += q;
      } else {
        pantry.push({ barcode: b, name: n, brand: br, quantity: q, expiry: e, category: c });
      }

      syncToGoogleSheets({ barcode: b, name: n, brand: br, quantity: q, expiry: e, category: c });
      renderPantry();
    }

    function changeQty(index, delta) {
      pantry[index].quantity += delta;
      if (pantry[index].quantity < 0) pantry[index].quantity = 0;
      renderPantry();
    }

    function removeItem(index) {
      pantry.splice(index, 1);
      renderPantry();
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark');
      document.body.classList.toggle('light');
    }

    function syncToGoogleSheets(item) {
      if (navigator.onLine) {
        fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(item)
        }).catch(err => console.error('Sync failed:', err));
      }
    }

    function testSync() {
      const statusEl = document.getElementById('syncStatus');
      const testItem = {
        barcode: 'TEST123456',
        name: 'Test Item',
        brand: 'PantryTest',
        quantity: 1,
        expiry: '',
        category: 'Test'
      };
      statusEl.textContent = 'Sending test sync...';
      statusEl.style.color = 'gray';

      fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(testItem)
      }).then(() => {
        statusEl.textContent = '‚úÖ Test sync sent (check sheet)';
        statusEl.style.color = 'green';
      }).catch(err => {
        statusEl.textContent = '‚ùå Sync failed: ' + err;
        statusEl.style.color = 'red';
      });
    }

    function startScanner() {
      if (!window.Html5Qrcode) return alert('Scanner failed to load.');
      if (scanner) {
        scanner.stop().then(() => {
          document.getElementById('reader').innerHTML = '';
          scanner = null;
        });
        return;
      }
      scanner = new Html5Qrcode('reader');
      scanner.start({ facingMode: 'environment' }, { fps: 10, qrbox: 250 },
        (decodedText) => {
          document.getElementById('barcode').value = decodedText;
          document.getElementById('beep').play();
          scanner.stop().then(() => {
            document.getElementById('reader').innerHTML = '';
            scanner = null;
          });
        },
        (err) => {}
      ).catch(err => alert('Camera access error: ' + err));
    }

    window.onload = loadFromGoogleSheets;
  </script>
</body>
</html>
