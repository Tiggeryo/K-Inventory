<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pantry Tracker</title>
  <style>
    /* Add your CSS here (same as previous) */
  </style>
</head>
<body class="light">
  <header>
    <h1>ğŸ Pantry Tracker</h1>
    <button class="toggle-btn" onclick="toggleDarkMode()">ğŸŒ“ Theme</button>
  </header>

  <div class="scanner">
    <button onclick="startScanner()">Start Barcode Scanner</button>
    <div id="reader"></div>
    <br><br>
    <button onclick="testSync()">ğŸ§ª Test Google Sheets Sync</button>
    <div id="syncStatus" style="margin-top: 0.5rem; font-weight: bold;"></div>
  </div>

  <form onsubmit="addItem(); return false;">
    <input id="barcode" type="text" placeholder="Barcode" required>
    <input id="name" type="text" placeholder="Item Name" required>
    <input id="brand" type="text" placeholder="Brand" required>
    <input id="quantity" type="number" placeholder="Quantity" min="1" value="1" required>
    <input id="expiry" type="date" placeholder="Expiry Date">
    <input id="category" type="text" placeholder="Category (e.g. Snacks, Dairy)" required>
    <button type="submit">Add to Pantry</button>
  </form>

  <div class="search-box">
    <input type="search" id="searchInput" placeholder="Search by name or brand..." oninput="renderPantry()">
  </div>

  <div class="pantry-list" id="pantryList"></div>

  <audio id="beep" src="https://www.soundjay.com/buttons/beep-07.mp3"></audio>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/YOUR_ID/exec';  // Replace with your Apps Script URL
    let pantry = JSON.parse(localStorage.getItem('pantryItems')) || [];

    async function loadFromGoogleSheets() {
      try {
        const res = await fetch(SCRIPT_URL);
        const data = await res.json();
        pantry = data.map(item => ({
          barcode: item.barcode,
          name: item.name,
          brand: item.brand,
          quantity: parseInt(item.quantity),
          expiry: item.expiry,
          category: item.category
        }));

        localStorage.setItem('pantryItems', JSON.stringify(pantry)); // Save to localStorage for offline
        renderPantry();
      } catch (err) {
        console.error("Failed to load from Google Sheets:", err);
        renderPantry(); // Fallback to localStorage
      }
    }

    function renderPantry() {
      const list = document.getElementById('pantryList');
      const search = document.getElementById('searchInput').value.toLowerCase();
      list.innerHTML = '';

      const filtered = pantry.filter(item =>
        item.name.toLowerCase().includes(search) || item.brand.toLowerCase().includes(search)
      );

      const grouped = groupByCategory(filtered);
      Object.keys(grouped).sort().forEach(key => {
        const header = document.createElement('div');
        header.className = 'category-header';
        header.textContent = grouped[key].label;
        list.appendChild(header);

        grouped[key].items.sort((a, b) => a.name.localeCompare(b.name)).forEach((item, i) => {
          const card = document.createElement('div');
          card.className = 'item-card';
          const days = daysUntil(item.expiry);
          let expiryColor = '';

          if (days < 0) expiryColor = 'color: darkred;';
          else if (days <= 3) expiryColor = 'color: red;';
          else if (days <= 7) expiryColor = 'color: orange;';

          let qtyStyle = '';
          if (item.quantity === 0) {
            qtyStyle = 'color: gray; text-decoration: line-through;';
          } else if (item.quantity === 1) {
            qtyStyle = 'color: orange;';
          }

          card.innerHTML = `
            <div class="item-info">
              <p><strong>${item.name}</strong> (${item.brand})</p>
              <p style="${qtyStyle}">Qty: ${item.quantity}${item.expiry ? ` <span style="${expiryColor}">| ğŸ—“ ${item.expiry}</span>` : ''}</p>
            </div>
            <div class="item-actions">
              <button class="light" onclick="changeQty(${i},1)">ï¼‹</button>
              <button class="light" onclick="changeQty(${i},-1)">ï¼</button>
              <button class="remove" onclick="removeItem(${i})">ğŸ—‘ï¸</button>
            </div>`;
          list.appendChild(card);
        });
      });

      localStorage.setItem('pantryItems', JSON.stringify(pantry)); // Save to localStorage
    }

    function groupByCategory(items) {
      const grouped = {};
      for (const item of items) {
        const key = normalizeCategory(item.category || "Uncategorized");
        if (!grouped[key]) grouped[key] = { label: item.category, items: [] };
        grouped[key].items.push(item);
      }
      return grouped;
    }

    function normalizeCategory(cat) {
      return cat.trim().toLowerCase();
    }

    function daysUntil(dateStr) {
      if (!dateStr) return Infinity;
      const today = new Date();
      const expiry = new Date(dateStr);
      return Math.floor((expiry - today) / (1000 * 60 * 60 * 24));
    }

    function addItem() {
      const b = document.getElementById('barcode').value.trim();
      const n = document.getElementById('name').value.trim();
      const br = document.getElementById('brand').value.trim();
      const q = +document.getElementById('quantity').value;
      const e = document.getElementById('expiry').value;
      const c = document.getElementById('category').value.trim();

      const normalizedC = normalizeCategory(c);
      const existing = pantry.find(i => i.barcode === b && normalizeCategory(i.category) === normalizedC);
      if (existing) {
        existing.quantity += q;
        if (e) existing.expiry = e;
      } else {
        pantry.push({ barcode: b, name: n, brand: br, quantity: q, expiry: e, category: c });
      }

      syncToGoogleSheets({ barcode: b, name: n, brand: br, quantity: q, expiry: e, category: c });
      renderPantry();
    }

    function changeQty(index, delta) {
      pantry[index].quantity += delta;
      if (pantry[index].quantity <= 0) pantry[index].quantity = 0;
      renderPantry();
    }

    function removeItem(index) {
      pantry.splice(index, 1);
      renderPantry();
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark');
      document.body.classList.toggle('light');
    }

    function syncToGoogleSheets(item) {
      if (navigator.onLine) {
        fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(item)
        }).catch(err => console.error("Sync failed:", err));
      } else {
        console.log("Offline, saving to localStorage");
      }
    }

    function testSync() {
      const statusEl = document.getElementById("syncStatus");
      const dummyData = {
        barcode: "TEST123456",
        name: "Test Item",
        brand: "PantryTest",
        quantity: 1,
        expiry: "",
        category: "Test"
      };

      statusEl.textContent = "Sending test sync...";
      statusEl.style.color = "gray";

      fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dummyData)
      }).then(() => {
        statusEl.textContent = "âœ… Test sync sent (check sheet)";
        statusEl.style.color = "green";
        setTimeout(() => statusEl.textContent = "", 3000);
      }).catch((err) => {
        statusEl.textContent = "âŒ Sync failed: " + err;
        statusEl.style.color = "red";
        setTimeout(() => statusEl.textContent = "", 5000);
      });
    }

    window.onload = loadFromGoogleSheets;
  </script>
</body>
</html>
