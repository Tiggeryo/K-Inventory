<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pantry Tracker</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      transition: background 0.3s, color 0.3s;
    }

    body.light {
      background: #fafafa;
      color: #222;
    }

    body.dark {
      background: #1e1e1e;
      color: #ddd;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: #6200ea;
      color: white;
    }

    h1 {
      margin: 0;
      font-size: 1.5rem;
    }

    .toggle-btn {
      background: transparent;
      border: none;
      color: white;
      font-size: 1rem;
      cursor: pointer;
    }

    .scanner, form, .search-box {
      margin: 1rem;
      background: white;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    body.dark .scanner, body.dark form, body.dark .search-box {
      background: #2a2a2a;
    }

    form input, form select, form button {
      width: calc(100% - 1rem);
      margin: 0.5rem 0;
      padding: 0.75rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    body.dark form input, body.dark form select {
      border: 1px solid #555;
      background: #333;
      color: #ddd;
    }

    .search-box input[type="search"] {
      padding: 0.5rem;
      font-size: 1rem;
      width: 100%;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    .pantry-list {
      margin: 1rem;
    }

    .category-header {
      font-weight: bold;
      font-size: 1.2rem;
      margin: 1rem 0 0.5rem;
      border-bottom: 1px solid #ccc;
      padding-bottom: 0.2rem;
    }

    .item-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      padding: 1rem;
      margin-bottom: 0.5rem;
      border-radius: 6px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    body.dark .item-card {
      background: #2a2a2a;
    }

    .item-info p {
      margin: 0.25rem 0;
    }

    .item-actions button {
      margin-left: 0.5rem;
      padding: 0.5rem;
      font-size: 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .item-actions button.light {
      background: #6200ea;
      color: white;
    }

    .item-actions button.remove {
      background: #b00020;
      color: white;
    }

    #reader {
      width: 100%;
      max-width: 400px;
      margin: auto;
    }

    audio {
      display: none;
    }
  </style>
</head>
<body class="light">
  <header>
    <h1>üçé Pantry Tracker</h1>
    <button class="toggle-btn" onclick="toggleDarkMode()">üåì Theme</button>
  </header>

 <div class="scanner">
  <button onclick="startScanner()">Start Barcode Scanner</button>
  <div id="reader"></div>
  <br><br>
  <button onclick="testSync()" style="margin-top: 1rem;">üß™ Test Google Sheets Sync</button>
  <div id="syncStatus" style="margin-top: 0.5rem; font-weight: bold;"></div>
</div>


  <form onsubmit="addItem(); return false;">
    <input id="barcode" type="text" placeholder="Barcode" required>
    <input id="name" type="text" placeholder="Item Name" required>
    <input id="brand" type="text" placeholder="Brand" required>
    <input id="quantity" type="number" placeholder="Quantity" min="1" value="1" required>
    <input id="expiry" type="date" placeholder="Expiry Date">
    <input id="category" type="text" placeholder="Category (e.g. Snacks, Dairy)" required>
    <button type="submit">Add to Pantry</button>
  </form>

  <div class="search-box">
    <input type="search" id="searchInput" placeholder="Search by name or brand..." oninput="renderPantry()">
  </div>

  <div class="pantry-list" id="pantryList"></div>

  <audio id="beep" src="https://www.soundjay.com/buttons/beep-07.mp3"></audio>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyS0HyqbqpcDVYrs4dCschzZQzwnqsE_SWv5r_f7dkpXnlQag0CFECeqL5EwF2-Zi4riQ/exec';

async function loadFromGoogleSheets() {
  try {
    const res = await fetch(SCRIPT_URL);
    const data = await res.json();

    pantry = data.map(item => ({
      barcode: item.barcode,
      name: item.name,
      brand: item.brand,
      quantity: parseInt(item.quantity),
      expiry: item.expiry,
      category: item.category
    }));

    renderPantry();
  } catch (err) {
    console.error("Failed to load from Google Sheets:", err);
    renderPantry(); // fallback to local
  }
}

window.onload = loadFromGoogleSheets;

    function testSync() {
  const statusEl = document.getElementById("syncStatus");
  const dummyData = {
    barcode: "TEST123456",
    name: "Test Item",
    brand: "PantryTest",
    quantity: 1,
    expiry: "",
    category: "Test"
  };

  statusEl.textContent = "Sending test sync...";
  statusEl.style.color = "gray";

  fetch('https://script.google.com/macros/s/AKfycbyS0HyqbqpcDVYrs4dCschzZQzwnqsE_SWv5r_f7dkpXnlQag0CFECeqL5EwF2-Zi4riQ/exec', {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(dummyData)
  }).then(() => {
    statusEl.textContent = "‚úÖ Test sync sent (check sheet)";
    statusEl.style.color = "green";
    setTimeout(() => statusEl.textContent = "", 3000);
  }).catch((err) => {
    statusEl.textContent = "‚ùå Sync failed: " + err;
    statusEl.style.color = "red";
    setTimeout(() => statusEl.textContent = "", 5000);
  });
}

    let pantry = JSON.parse(localStorage.getItem('pantryItems')) || [];

    function normalizeCategory(cat) {
      return cat.trim().toLowerCase();
    }

    function groupByCategory(items) {
      const grouped = {};
      for (const item of items) {
        const key = normalizeCategory(item.category || "Uncategorized");
        if (!grouped[key]) grouped[key] = { label: item.category, items: [] };
        grouped[key].items.push(item);
      }
      return grouped;
    }

    function daysUntil(dateStr) {
      if (!dateStr) return Infinity;
      const today = new Date();
      const expiry = new Date(dateStr);
      return Math.floor((expiry - today) / (1000 * 60 * 60 * 24));
    }

    function renderPantry() {
      const list = document.getElementById('pantryList');
      const search = document.getElementById('searchInput').value.toLowerCase();
      list.innerHTML = '';

      const filtered = pantry.filter(item =>
        item.name.toLowerCase().includes(search) ||
        item.brand.toLowerCase().includes(search)
      );

      const grouped = groupByCategory(filtered);

      Object.keys(grouped).sort().forEach(key => {
        const header = document.createElement('div');
        header.className = 'category-header';
        header.textContent = grouped[key].label;
        list.appendChild(header);

        grouped[key].items.sort((a, b) => a.name.localeCompare(b.name)).forEach((item, i) => {
          const index = pantry.findIndex(p => p.barcode === item.barcode && normalizeCategory(p.category) === key);
          const card = document.createElement('div');
          card.className = 'item-card';

          const days = daysUntil(item.expiry);
          let expiryColor = '';
          if (days < 0) expiryColor = 'color: darkred;';
          else if (days <= 3) expiryColor = 'color: red;';
          else if (days <= 7) expiryColor = 'color: orange;';

          let qtyStyle = '';
          if (item.quantity === 0) {
            qtyStyle = 'color: gray; text-decoration: line-through;';
          } else if (item.quantity === 1) {
            qtyStyle = 'color: orange;';
          }

          card.innerHTML = `
            <div class="item-info">
              <p><strong>${item.name}</strong> (${item.brand})</p>
              <p style="${qtyStyle}">Qty: ${item.quantity}${item.expiry ? ` <span style="${expiryColor}">| üóì ${item.expiry}</span>` : ''}</p>
            </div>
            <div class="item-actions">
              <button class="light" onclick="changeQty(${index},1)">Ôºã</button>
              <button class="light" onclick="changeQty(${index},-1)">Ôºç</button>
              <button class="remove" onclick="removeItem(${index})">üóëÔ∏è</button>
            </div>`;
          list.appendChild(card);
        });
      });

      localStorage.setItem('pantryItems', JSON.stringify(pantry));
    }

    function addItem() {
      const b = document.getElementById('barcode').value.trim();
      const n = document.getElementById('name').value.trim();
      const br = document.getElementById('brand').value.trim();
      const q = +document.getElementById('quantity').value;
      const e = document.getElementById('expiry').value;
      const c = document.getElementById('category').value.trim();

      const normalizedC = normalizeCategory(c);
      const existing = pantry.find(i => i.barcode === b && normalizeCategory(i.category) === normalizedC);
      if (existing) {
        existing.quantity += q;
        if (e) existing.expiry = e;
      } else {
        pantry.push({ barcode: b, name: n, brand: br, quantity: q, expiry: e, category: c });
      }

      syncToGoogleSheets({ barcode: b, name: n, brand: br, quantity: q, expiry: e, category: c });
      renderPantry();
    }

    function changeQty(index, delta) {
      pantry[index].quantity += delta;
      if (pantry[index].quantity <= 0) pantry[index].quantity = 0;
      renderPantry();
    }

    function removeItem(index) {
      pantry.splice(index, 1);
      renderPantry();
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark');
      document.body.classList.toggle('light');
    }

    function syncToGoogleSheets(item) {
      fetch('YOUR_GOOGLE_SCRIPT_URL_HERE', {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(item)
      });
    }

    function startScanner() {
      const beep = document.getElementById('beep');
      const reader = new Html5Qrcode("reader");
      reader.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
        (txt) => {
          beep.play();
          document.getElementById('barcode').value = txt;
          fetch(`https://world.openfoodfacts.org/api/v0/product/${txt}.json`)
            .then(r => r.json())
            .then(d => {
              document.getElementById('name').value = d.product?.product_name || '';
              document.getElementById('brand').value = d.product?.brands || '';
            });
          reader.stop();
        }, () => {});
    }

    renderPantry();
  </script>
</body>
</html>
